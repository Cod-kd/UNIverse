<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Registration & Login</title>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getDatabase, ref, push, set, child, get } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "passimage-8813b.firebaseapp.com",
            projectId: "passimage-8813b",
            storageBucket: "passimage-8813b.appspot.com",
            messagingSenderId: "220311594812",
            appId: "1:220311594812:web:130b5992efff979357a039",
            measurementId: "G-3MDWF0SCTQ",
            databaseURL: "https://passimage-8813b-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Function to hash image data using SHA-256
        async function hashImage(imageData) {
            const buffer = new Uint8Array(imageData.data.buffer);
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(byte => byte.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Registration form logic
        let registerImageHash = '';

        async function handleRegisterFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function (event) {
                const image = new Image();
                image.onload = async function () {
                    const canvas = document.createElement('canvas');
                    canvas.width = image.width;
                    canvas.height = image.height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(image, 0, 0);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    registerImageHash = await hashImage(imageData); // Call hashImage function here
                    console.log(registerImageHash);
                };
                image.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Login form logic
        let loginImageHash = '';

        async function handleLoginFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function (event) {
                const image = new Image();
                image.onload = async function () {
                    const canvas = document.createElement('canvas');
                    canvas.width = image.width;
                    canvas.height = image.height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(image, 0, 0);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    loginImageHash = await hashImage(imageData); // Call hashImage function here
                    console.log(loginImageHash);
                };
                image.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Register user function
        async function registerUser(event) {
            event.preventDefault();
            const username = document.getElementById('usernameInp').value;

            if (!username || !registerImageHash) {
                alert('Please enter a username and select an image.');
                return;
            }

            const userRef = ref(database, 'users/' + username);
            await set(userRef, {
                username: username,
                imageHash: registerImageHash
            });

            alert('User registered successfully!');
            // Reset form fields after successful registration
            document.getElementById('usernameInp').value = '';
            document.getElementById('passimgInp').value = '';
            registerImageHash = ''; // Reset the image hash variable
        }


        // Login user function
        async function loginUser(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;

            if (!username || !loginImageHash) {
                alert('Please enter a username and select an image.');
                return;
            }

            const userRef = ref(database, 'users/' + username);
            const snapshot = await get(child(userRef, 'imageHash'));

            if (snapshot.exists()) {
                const storedHash = snapshot.val();
                if (storedHash === loginImageHash) {
                    alert('Successful login!');
                } else {
                    alert('Access denied. Image hash does not match.');
                }
            } else {
                alert('No account in database.');
            }
        }

        // Event listeners for registration and login forms
        document.addEventListener('DOMContentLoaded', () => {
            // Registration form
            const passimgInp = document.getElementById("passimgInp");
            passimgInp.addEventListener("change", handleRegisterFileSelect);

            const registerBtn = document.getElementById("registerBtn");
            registerBtn.addEventListener("click", function () {
                registerUser(new Event('submit'));
            });

            // Login form
            const loginPassimgInp = document.getElementById("loginPassimgInp");
            loginPassimgInp.addEventListener("change", handleLoginFileSelect);

            const loginBtn = document.getElementById("loginBtn");
            loginBtn.addEventListener("click", function () {
                loginUser(new Event('submit'));
            });
        });
    </script>
</head>

<body>
    <!-- Registration Form -->
    <form id="registerForm">
        <h2>Registration</h2>
        <label for="usernameInp">Username</label>
        <input type="text" id="usernameInp" required>
        <br>
        <label for="passimgInp">Passimage</label>
        <input type="file" accept="image/*" id="passimgInp" required>
        <br>
    </form>
    <button id="registerBtn">Register</button>


    <!-- Login Form -->
    <form id="loginForm">
        <h2>Login</h2>
        <label for="loginUsername">Username</label>
        <input type="text" id="loginUsername" required>
        <br>
        <label for="loginPassimgInp">Passimage</label>
        <input type="file" accept="image/*" id="loginPassimgInp" required>
        <br>
    </form>
    <button id="loginBtn">Login</button>
</body>

</html>