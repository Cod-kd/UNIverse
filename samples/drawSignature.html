<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Canvas Drawing</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        canvas {
            touch-action: none;
            cursor: cell;
            border: 1px solid #ccc;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
        }

        #userDataDiv {
            position: fixed;
            width: 350px;
            background-color: var(--dark1);
            padding: 10px;
            border-radius: 12px;
            top: 50%;
            border: 1px solid red;
        }
    </style>
</head>

<body>
    <canvas id="canvas"></canvas>
    <button id="resetCanvasBtn">Reset</button>
    <button id="saveCanvasBtn">Save</button>
    <div id="userDataDiv"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        const canvas = document.getElementById("canvas");
        const resetCanvasBtn = document.getElementById("resetCanvasBtn");
        const saveCanvasBtn = document.getElementById("saveCanvasBtn");
        const userDataDiv = document.getElementById("userDataDiv");

        let drawColor = "#FF5A1F";
        let drawWidth = 2;
        let isDrawing = false;

        /*
        `
            <p>Email: ${formData.email}</p>
            <p>Username: ${formData.username}</p>
            <p>Gender: ${formData.gender}</p>
            <p>Birth Date: ${formData.birthDate.slice(0, 4)}/${formData.birthDate.slice(4, 6)}/${formData.birthDate.slice(6, 8)}</p>
            <p>Password: ************</p>
            <h1>UNIcard</h1>
        `
        */
        // Canvas setup
        canvas.width = 300;
        canvas.height = 300;
        const context = canvas.getContext("2d");
        context.fillStyle = "#141414";
        context.fillRect(0, 0, canvas.width, canvas.height);

        // Event listeners for canvas drawing
        canvas.addEventListener("touchstart", startDrawing, { passive: false });
        canvas.addEventListener("touchmove", drawSignature, { passive: false });
        canvas.addEventListener("mousedown", startDrawing);
        canvas.addEventListener("mousemove", drawSignature);
        canvas.addEventListener("mouseup", stopDrawing);
        canvas.addEventListener("mouseout", stopDrawing);
        canvas.addEventListener("touchend", stopDrawing);
        canvas.addEventListener("touchcancel", stopDrawing);

        // Button event listeners
        resetCanvasBtn.addEventListener("click", clearCanvas);
        saveCanvasBtn.addEventListener("click", saveCanvas);

        // Helper function to get event position
        function getEventPosition(event) {
            const rect = canvas.getBoundingClientRect();
            if (event.touches && event.touches.length > 0) {
                return {
                    x: event.touches[0].clientX - rect.left,
                    y: event.touches[0].clientY - rect.top
                };
            } else {
                return {
                    x: event.clientX - rect.left,
                    y: event.clientY - rect.top
                };
            }
        }

        // Canvas functions
        function startDrawing(event) {
            isDrawing = true;
            const pos = getEventPosition(event);
            context.beginPath();
            context.moveTo(pos.x, pos.y);
            event.preventDefault();
        }

        function drawSignature(event) {
            if (!isDrawing) return;
            const pos = getEventPosition(event);
            context.lineTo(pos.x, pos.y);
            context.strokeStyle = drawColor;
            context.lineWidth = drawWidth;
            context.lineCap = "round";
            context.lineJoin = "round";
            context.stroke();
            event.preventDefault();
        }

        function stopDrawing(event) {
            if (isDrawing) {
                isDrawing = false;
                event.preventDefault();
            }
        }

        function clearCanvas() {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.fillStyle = "#141414";
            context.fillRect(0, 0, canvas.width, canvas.height);
        }

        async function hashImage(file) {
            const arrayBuffer = await file.arrayBuffer();
            const buffer = new Uint8Array(arrayBuffer);
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(byte => byte.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        async function saveCanvas() {
            try {
                // Step 1: Capture the main canvas
                const canvasScreenshot = await html2canvas(canvas, { backgroundColor: null });

                // Step 2: Create a new canvas for resizing
                const resizedCanvas = document.createElement('canvas');
                resizedCanvas.width = 50;
                resizedCanvas.height = 50;
                const resizedContext = resizedCanvas.getContext('2d');

                // Step 3: Draw the captured canvas onto the resized canvas
                resizedContext.drawImage(canvasScreenshot, 0, 0, resizedCanvas.width, resizedCanvas.height);

                // Step 4: Get the data URL of the resized canvas
                const canvasDataUrl = resizedCanvas.toDataURL('image/jpeg', 0.5);

                // Step 5: Put the captured main canvas to the userDataDiv
                userDataDiv.innerHTML = `
            <p>Email: test@gmail.com</p>
            <p>Username: testuser</p>
            <p>Gender: Male</p>
            <p>Birth Date: 2005/10/11</p>
            <p>Password: ************</p>
            <h1>UNIcard</h1>
            <img src="${canvasDataUrl}" alt="signature">
        `;

                // Step 6: Screenshot the outputDiv
                const UNIcardScreenshot = await html2canvas(userDataDiv);

                // Step 7: Convert the screenshot of outputDiv to hashHex
                UNIcardScreenshot.toBlob(async (blob) => {
                    if (!blob) {
                        console.error("Blob is null, cannot proceed.");
                        throw new Error("Failed to create blob from UNIcard screenshot.");
                    }
                    const hashHex = await hashImage(blob);
                    console.log(`Image Hash: ${hashHex}`);
                }, 'image/png');

            } catch (error) {
                console.error("Error in saveCanvas:", error);
                userDataDiv.textContent = "An error occurred while processing the image.";
            }
        }


    </script>
</body>

</html>